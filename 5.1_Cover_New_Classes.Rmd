---
title: 'Abundance analysis based on new classification'
author: "Willem Goossens"
date: "`r Sys.Date()`"
output: html_document
---

This script analyses whether neophytes are more dominant and frequent than native plants or not:

# 1 DATA
## 1.1 Preparation
We first clean the environment.
```{r, echo=T}
rm(list=ls())
```

Subsequently we load the required packages.
```{r, warnings=F, message=F}
library(readr)
library(dplyr)
library(ggplot2)
library(arsenal)
library(doParallel)
```

## 1.2 Data loaded
This script analyses whether neophytes are more dominant and frequent than native plants or not.
```{r, warnings=F, message=F}
# Eva data for which plots are available and after correcting for incorrect or weird plot observations
eva <- read_csv("fullPlotEva.csv")
```

Load filtered Data containing the richness and indicator values for each plot. In case we want to save computing time: down sample it.
```{r, warnings=F, message=F}
# header like data, filtered and appended with EIVE and DIV
fullPlotData <- read_csv("fullPlotData.csv")

fast <- T
if(fast) {
  fullPlotData <- fullPlotData[runif(length(fullPlotData$PlotObservationID)) > 0.99,]
  eva <- eva[eva$PlotObservationID %in% fullPlotData$PlotObservationID,]
}
```

Load the neophyte definitions:
```{r, message=F}
# Data on which species are neophytes
species_country_status<- read_csv("species_country_status.csv")
# Assign these names to the eva list
extra_EU <- unique(species_country_status$species[species_country_status$Neophyte=="extra"])
intra_EU <- unique(species_country_status$species[species_country_status$Neophyte=="intra"])
```


Remove species that are not defined or to be excluded
```{r, warnings=F}
remove<- read_csv("not_defined.csv")
remove<- as.vector(unlist(remove))
eva<- eva[!(eva$species %in% remove),]
```


Assign classification to species
```{r}
# Only observation ID and Region
fullPlot2<- fullPlotData[,c("PlotObservationID","Region")]
# Right join to keep only species present in fullplot (otherwise a lot of NAs)
eva<- right_join(eva, fullPlot2, by = c("PlotObservationID"="PlotObservationID"))
# Join eva and classification
eva_country_neophyte<- left_join(eva, species_country_status, by= c("Region"= "Region", "species"= "species"))
# Look at how much from every type are present
table(eva_country_neophyte$Neophyte)
```


# 2 COVER
```{r}
# For speed optimization we extract only the necessary information from EVA
reducedEva <- eva_country_neophyte |> select(PlotObservationID, Region, species, Neophyte,`Cover %`)

# Previously it was possible to assign the class later, now we have the definition already in the beginning (as some species in dataset can be native to one region and neophyte in another) this is not possible anymore. We will do this analysis per class and later combine the results
nativeEva <- reducedEva[reducedEva$Neophyte=="native",]
uniqueNative <- unique(nativeEva$species)

speciesDominance <- data.frame(names = character(), coverMedian = numeric(), coverMean = numeric(), var = numeric(), numberOfPlots = integer(), neophyte = logical())

uniqueSpecies <- unique(reducedEva$species)
status<- unique(reducedEva$Neophyte)

parallel::detectCores()
n.cores <- parallel::detectCores() - 2
my.cluster <- parallel::makeCluster(
  n.cores, 
  type = "PSOCK"
)
print(my.cluster)
doParallel::registerDoParallel(cl = my.cluster)
foreach::getDoParRegistered()
foreach::getDoParWorkers()

begin<- Sys.time()

speciesDominance<-foreach(i= 1:length(uniqueNative), .combine='rbind', .packages=c("dplyr","mgcv")) %dopar% {
  # Get dataset for each unique species
  tmp <- nativeEva[nativeEva$species == uniqueNative[i],]
  # Make ID a factor
  tmp$PlotObservationID <- as.factor(tmp$PlotObservationID)
  # Group by plot and calculate the mean species cover for that species in all plots where it is present
  tmp <- tmp |> group_by(PlotObservationID) |> summarise(cover = mean(`Cover %`))
  # We are only interested in the dominance of species occuring in at least 50 plots
  if(length(tmp$PlotObservationID) >= 0) {
    # Get the summary (median and mean at place 3 and 4) for when the species is present
    sum <- summary(tmp$cover)
    speciesDominance <- c(names = uniqueSpecies[i], coverMedian = sum[[3]], coverMean = sum[[4]], var = var(tmp$cover), 
        numberOfPlots =length(tmp$PlotObservationID), neophyte = "native")
  }
}
end<- Sys.time()
round(end-begin)

speciesDominance<- as.data.frame(speciesDominance)
row.names(speciesDominance)<- c(1:length(speciesDominance$names))
speciesDominance[,2]<- as.numeric(speciesDominance[,2])
speciesDominance[,3]<- as.numeric(speciesDominance[,3])
speciesDominance[,4]<- as.numeric(speciesDominance[,4])
speciesDominance[,5]<- as.numeric(speciesDominance[,5])
parallel::stopCluster(cl = my.cluster)

nativeCover<- speciesDominance
```


```{r}
intraEva <- reducedEva[reducedEva$Neophyte=="intra",]
uniqueintra <- unique(intraEva$species)

parallel::detectCores()
n.cores <- parallel::detectCores() - 2
my.cluster <- parallel::makeCluster(
  n.cores, 
  type = "PSOCK"
)
print(my.cluster)
doParallel::registerDoParallel(cl = my.cluster)
foreach::getDoParRegistered()
foreach::getDoParWorkers()

begin<- Sys.time()

speciesDominance<-foreach(i= 1:length(uniqueintra), .combine='rbind', .packages=c("dplyr","mgcv")) %dopar% {
  # Get dataset for each unique species
  tmp <- intraEva[intraEva$species == uniqueintra[i],]
  # Make ID a factor
  tmp$PlotObservationID <- as.factor(tmp$PlotObservationID)
  # Group by plot and calculate the mean species cover for that species in all plots where it is present
  tmp <- tmp |> group_by(PlotObservationID) |> summarise(cover = mean(`Cover %`))
  # We are only interested in the dominance of species occuring in at least 50 plots
  if(length(tmp$PlotObservationID) >= 0) {
    # Get the summary (median and mean at place 3 and 4) for when the species is present
    sum <- summary(tmp$cover)
    speciesDominance <- c(names = uniqueSpecies[i], coverMedian = sum[[3]], coverMean = sum[[4]], var = var(tmp$cover), 
        numberOfPlots =length(tmp$PlotObservationID), neophyte = "intra")
  }
}
end<- Sys.time()
round(end-begin)

speciesDominance<- as.data.frame(speciesDominance)
row.names(speciesDominance)<- c(1:length(speciesDominance$names))
speciesDominance[,2]<- as.numeric(speciesDominance[,2])
speciesDominance[,3]<- as.numeric(speciesDominance[,3])
speciesDominance[,4]<- as.numeric(speciesDominance[,4])
speciesDominance[,5]<- as.numeric(speciesDominance[,5])
parallel::stopCluster(cl = my.cluster)

intraCover<- speciesDominance
```


```{r}

extraEva <- reducedEva[reducedEva$Neophyte=="extra",]
uniqueextra <- unique(extraEva$species)

parallel::detectCores()
n.cores <- parallel::detectCores() - 2
my.cluster <- parallel::makeCluster(
  n.cores, 
  type = "PSOCK"
)
print(my.cluster)
doParallel::registerDoParallel(cl = my.cluster)
foreach::getDoParRegistered()
foreach::getDoParWorkers()

begin<- Sys.time()

speciesDominance<-foreach(i= 1:length(uniqueextra), .combine='rbind', .packages=c("dplyr","mgcv")) %dopar% {
  # Get dataset for each unique species
  tmp <- extraEva[extraEva$species == uniqueextra[i],]
  # Make ID a factor
  tmp$PlotObservationID <- as.factor(tmp$PlotObservationID)
  # Group by plot and calculate the mean species cover for that species in all plots where it is present
  tmp <- tmp |> group_by(PlotObservationID) |> summarise(cover = mean(`Cover %`))
  # We are only interested in the dominance of species occuring in at least 50 plots
  if(length(tmp$PlotObservationID) >= 0) {
    # Get the summary (median and mean at place 3 and 4) for when the species is present
    sum <- summary(tmp$cover)
    speciesDominance <- c(names = uniqueSpecies[i], coverMedian = sum[[3]], coverMean = sum[[4]], var = var(tmp$cover), 
        numberOfPlots =length(tmp$PlotObservationID), neophyte = "extra")
  }
}
end<- Sys.time()
round(end-begin)

speciesDominance<- as.data.frame(speciesDominance)
speciesDominance[,2]<- as.numeric(speciesDominance[,2])
speciesDominance[,3]<- as.numeric(speciesDominance[,3])
speciesDominance[,4]<- as.numeric(speciesDominance[,4])
speciesDominance[,5]<- as.numeric(speciesDominance[,5])
row.names(speciesDominance)<- c(1:length(speciesDominance$names))
parallel::stopCluster(cl = my.cluster)

extraCover<- speciesDominance
summary(extraCover)
```

Combine them all
```{r}
speciesDominance<- rbind(nativeCover, intraCover, extraCover)
speciesDominance[(which(duplicated(speciesDominance$names))),]


```

We also analyse which species are significantly negative / positive when compared to the distribution of the native species. We do this for all plants.
```{r}
# Get the quantile values of all native plant species.Cutoff values at 0.01 and 0.05 chances (both upper and lower limit)
quantiles <- quantile(speciesDominance$coverMean[speciesDominance$neophyte=="native"], probs = c(0, 0.01, 0.05, 0.95, 0.99, 1))

# Assign each species to a class
speciesDominance$significantCoverMean <- as.factor(cut(speciesDominance$coverMean, breaks = quantiles, labels = c("p=0.01 negative", "p=0.05 negative", "", "p=0.05 positive", "p=0.01 positive"), right = TRUE))
```


```{r}
ggplot(speciesDominance, mapping = aes(x = log10(coverMean), after_stat(density), colour = neophyte)) + geom_freqpoly(binwidth = 0.1)
ggplot(speciesDominance, mapping = aes(x= neophyte, y = log10(coverMean), colour = neophyte)) + 
  # create violin plot with x axis no title and y 
  geom_violin()
```

